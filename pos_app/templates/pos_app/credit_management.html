{% extends 'pos_app/base.html' %}

{% block title %}Credit Management{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #4f46e5;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --info-color: #3b82f6;
        --light-bg: #f8fafc;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --border-radius: 12px;
    }

    .credit-management-container {
        background: var(--light-bg);
        min-height: calc(100vh - 120px);
        padding: 2rem 0;
    }

    .credit-header {
        background: linear-gradient(135deg, var(--primary-color), var(--info-color));
        color: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
    }

    .stats-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        text-align: center;
    }

    .stats-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .debt-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .debt-card-header {
        padding: 1.5rem;
        background: linear-gradient(135deg, var(--success-color), #059669);
        color: white;
    }

    .customer-debt-item {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: between;
        align-items: center;
    }

    .customer-debt-item:last-child {
        border-bottom: none;
    }

    .customer-info h6 {
        margin-bottom: 0.25rem;
        font-weight: 600;
    }

    .debt-amount {
        font-size: 1.25rem;
        font-weight: 700;
    }

    .btn-receive-payment {
        background: linear-gradient(135deg, var(--success-color), #059669);
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-receive-payment:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        color: white;
    }

    .overdue-indicator {
        background: linear-gradient(135deg, var(--danger-color), #dc2626);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .payment-history-table {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--card-shadow);
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .credit-management-container {
            padding: 1rem 0;
        }
        
        .credit-header {
            padding: 1.5rem;
            text-align: center;
        }
        
        .credit-header .d-flex {
            flex-direction: column !important;
            align-items: center !important;
        }
        
        .credit-header .text-end {
            text-align: center !important;
            margin-top: 1rem;
        }
        
        .stats-value {
            font-size: 1.5rem;
        }
        
        .customer-debt-item {
            flex-direction: column;
            align-items: stretch !important;
            gap: 1rem;
            padding: 1rem;
        }
        
        .customer-info {
            text-align: center;
        }
        
        .debt-amount {
            font-size: 1.1rem;
            text-align: center;
        }
        
        .d-flex.flex-column.gap-2 {
            flex-direction: row !important;
            justify-content: center;
            gap: 0.5rem !important;
        }
        
        .btn-receive-payment, .btn-outline-primary {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        
        .container-fluid {
            padding: 0 1rem;
        }
        
        .row {
            margin: 0;
        }
        
        .col-md-8, .col-md-4 {
            padding: 0 0.5rem;
        }
    }

    @media (max-width: 576px) {
        .credit-header h1 {
            font-size: 1.5rem;
        }
        
        .stats-card {
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .stats-value {
            font-size: 1.2rem;
        }
        
        .customer-debt-item {
            padding: 0.8rem;
        }
        
        .customer-info h6 {
            font-size: 0.9rem;
        }
        
        .customer-info p {
            font-size: 0.8rem;
        }
        
        .btn-receive-payment, .btn-outline-primary {
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="credit-management-container">
    <div class="container-fluid">
        <!-- Header -->
        <div class="credit-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2">Credit Management</h1>
                    <p class="mb-0 opacity-75">Manage customer debts and receive payments</p>
                </div>
                <div class="text-end">
                    <button class="btn btn-outline-light" onclick="location.reload()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <a href="{% url 'pos:credit_report_overall' %}" class="btn btn-light ms-2">
                        <i class="fas fa-chart-line me-2"></i>View Credit Report
                    </a>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-value">{{ business.currency_symbol }}{{ total_outstanding|floatformat:0 }}</div>
                    <div class="text-muted">Total Outstanding</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-value">{{ customers_count }}</div>
                    <div class="text-muted">Customers with Debt</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-value text-danger">{{ overdue_debts|length }}</div>
                    <div class="text-muted">Overdue Accounts</div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Customers with Debt -->
            <div class="col-md-8">
                <div class="debt-card">
                    <div class="debt-card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>Customers with Outstanding Debt
                        </h5>
                    </div>
                    <div class="debt-card-body">
                        {% for customer in customers_with_debt %}
                        <div class="customer-debt-item">
                            <div class="customer-info flex-grow-1">
                                <h6>{{ customer.full_name }}</h6>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-envelope me-1"></i>{{ customer.email|default:"No email" }}
                                    <i class="fas fa-phone ms-3 me-1"></i>{{ customer.phone|default:"No phone" }}
                                </p>
                                {% if customer.current_debt > customer.credit_limit %}
                                <span class="overdue-indicator">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Over Limit
                                </span>
                                {% endif %}
                            </div>
                            <div class="text-end me-3">
                                <div class="debt-amount text-danger">
                                    {{ business.currency_symbol }}{{ customer.current_debt|floatformat:2 }}
                                </div>
                                <small class="text-muted">
                                    Limit: {{ business.currency_symbol }}{{ customer.credit_limit|floatformat:0 }}
                                </small>
                            </div>
                            <div class="d-flex flex-column gap-2">
                                <button class="btn btn-receive-payment" 
                                    onclick="openPaymentModal({{ customer.id }})">
                                    <i class="fas fa-money-bill-wave me-1"></i>Receive Payment
                                </button>
                                <a href="{% url 'pos:credit_report_customer' customer.id %}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-file-alt me-1"></i>Report
                                </a>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-5">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h5>No Outstanding Debts</h5>
                            <p class="text-muted">All customers have cleared their debts.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Customers without Current Debt -->
                {% if customers_without_debt %}
                <div class="debt-card mt-4">
                    <div class="debt-card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Customers - No Current Debt
                        </h5>
                        <small class="text-muted">View credit history and make payments</small>
                    </div>
                    <div class="debt-card-body">
                        {% for customer in customers_without_debt %}
                        <div class="customer-debt-item">
                            <div class="customer-info flex-grow-1">
                                <h6>{{ customer.full_name }}</h6>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-envelope me-1"></i>{{ customer.email|default:"No email" }}
                                    <i class="fas fa-phone ms-3 me-1"></i>{{ customer.phone|default:"No phone" }}
                                </p>
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>No Outstanding Debt
                                </span>
                            </div>
                            <div class="text-end me-3">
                                <div class="debt-amount text-success">
                                    {{ business.currency_symbol }}0.00
                                </div>
                                <small class="text-muted">
                                    Limit: {{ business.currency_symbol }}{{ customer.credit_limit|floatformat:0 }}
                                </small>
                            </div>
                            <div class="d-flex flex-column gap-2">
                                <a href="{% url 'pos:credit_report_customer' customer.id %}" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-file-alt me-1"></i>Credit History
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Recent Payment History -->
            <div class="col-md-4">
                <div class="payment-history-table">
                    <div class="p-3 bg-light border-bottom">
                        <h6 class="mb-0">
                            <i class="fas fa-history me-2"></i>Recent Payments
                        </h6>
                    </div>
                    <div class="p-0">
                        {% for payment in debt_payments|slice:":10" %}
                        <div class="p-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <strong class="text-sm">{{ payment.customer.full_name }}</strong>
                                <span class="badge {% if payment.payment_type == 'payment' %}bg-success{% else %}bg-warning{% endif %}">
                                    {% if payment.payment_type == 'payment' %}
                                        -{{ business.currency_symbol }}{{ payment.amount }}
                                    {% else %}
                                        +{{ business.currency_symbol }}{{ payment.amount }}
                                    {% endif %}
                                </span>
                            </div>
                            <small class="text-muted">
                                {{ payment.created_at|date:"M d, H:i" }}
                                {% if payment.payment_method %}
                                    • {{ payment.get_payment_method_display }}
                                {% endif %}
                            </small>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <p class="text-muted mb-0">No recent payments</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Receive Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="payment-form">
                    <input type="hidden" id="customer-id">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Customer:</label>
                        <div id="customer-name" class="form-control-plaintext"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Current Debt:</label>
                        <div id="current-debt" class="form-control-plaintext text-danger fs-5"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment-amount" class="form-label">Payment Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">{{ business.currency_symbol }}</span>
                            <input type="number" class="form-control" id="payment-amount" 
                                   step="0.01" min="0.01" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment-method" class="form-label">Payment Method</label>
                        <select class="form-select" id="payment-method">
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="mobile_payment">Mobile Payment</option>
                            <option value="bank_transfer">Bank Transfer</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="link-sale" class="form-label">Link to Sale (optional)</label>
                        <select id="link-sale" class="form-select">
                            <option value="">-- Select sale to apply payment to --</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment-reference" class="form-label">Reference (Optional)</label>
                        <input type="text" class="form-control" id="payment-reference" 
                               placeholder="Transaction ID, receipt number, etc.">
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="payment-notes" rows="2" 
                                  placeholder="Additional notes about this payment"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="process-payment-btn" class="btn btn-success">
                    <i class="fas fa-check-circle me-1"></i>Process Payment
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let paymentModal;
let currentCustomerDebt = 0;

document.addEventListener('DOMContentLoaded', function() {
    paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    
    document.getElementById('process-payment-btn').addEventListener('click', processPayment);
    
    // Auto-calculate remaining debt
    document.getElementById('payment-amount').addEventListener('input', function() {
        const amount = parseFloat(this.value) || 0;
        const remaining = Math.max(0, currentCustomerDebt - amount);
        
        if (amount > currentCustomerDebt) {
            this.value = currentCustomerDebt.toFixed(2);
        }
    });
});

function openPaymentModal(customerId) {
    // Debug: Log the available customers and the ID we're looking for
    console.log('Looking for customer ID:', customerId);
    console.log('Available customers:', window.customersWithDebt);
    
    // Lookup customer details from the embedded JSON (now includes all customers)
    const cust = (window.customersWithDebt || []).find(c => c.id == customerId);
    
    if (!cust) {
        console.error('Customer not found! ID:', customerId, 'Available IDs:', (window.customersWithDebt || []).map(c => c.id));
        alert('Customer not found. Please refresh the page and try again.');
        return;
    }
    
    const customerName = cust.full_name || 'Unknown Customer';
    const debtAmount = parseFloat(cust.current_debt) || 0;

    currentCustomerDebt = debtAmount;

    document.getElementById('customer-id').value = customerId;
    document.getElementById('customer-name').textContent = customerName;
    document.getElementById('current-debt').textContent = '{{ business.currency_symbol }}' + debtAmount.toFixed(2);
    document.getElementById('payment-amount').value = '';
    
    // For customers without debt, allow any positive amount
    if (debtAmount > 0) {
        document.getElementById('payment-amount').max = debtAmount;
        document.getElementById('payment-amount').placeholder = `Max: ${debtAmount.toFixed(2)}`;
    } else {
        document.getElementById('payment-amount').removeAttribute('max');
        document.getElementById('payment-amount').placeholder = 'Enter payment amount';
    }
    
    document.getElementById('payment-method').value = 'cash';
    document.getElementById('payment-reference').value = '';
    document.getElementById('payment-notes').value = '';

    // Populate sale selector for this customer so the user can link the payment
    try {
        populateSaleSelect(customerId);
    } catch (e) {
        console.warn('populateSaleSelect error', e);
    }

    paymentModal.show();

    setTimeout(() => {
        document.getElementById('payment-amount').focus();
    }, 500);
}

// Populate sale select when opening modal
function populateSaleSelect(customerId) {
    const select = document.getElementById('link-sale');
    select.innerHTML = '<option value="">-- Select sale to apply payment to --</option>';
    const salesMap = window.customerCreditSales || {};
    const list = salesMap[customerId] || [];
    list.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        const remaining = Number(s.remaining || 0).toFixed(2);
        const created = s.created_at ? new Date(s.created_at).toLocaleString() : '';
        opt.textContent = `${s.invoice_number} - Remaining: {{ business.currency_symbol }}${remaining} - ${created}`;
        select.appendChild(opt);
    });
}

function processPayment() {
    const customerId = document.getElementById('customer-id').value;
    const amount = parseFloat(document.getElementById('payment-amount').value);
    const paymentMethod = document.getElementById('payment-method').value;
    const reference = document.getElementById('payment-reference').value;
    const notes = document.getElementById('payment-notes').value;
    
    if (!amount || amount <= 0) {
        alert('Please enter a valid payment amount');
        return;
    }
    
    // Only check debt limit if customer has existing debt
    if (currentCustomerDebt > 0 && amount > currentCustomerDebt) {
        alert('Payment amount cannot exceed the current debt');
        return;
    }
    
    const paymentData = {
        customer_id: customerId,
        amount: amount,
        payment_method: paymentMethod,
        reference: reference,
        notes: notes
    };
    const saleSelect = document.getElementById('link-sale');
    const saleId = saleSelect ? (saleSelect.value || null) : null;
    paymentData.sale_id = saleId;
    
    fetch('{% url "pos:receive_payment" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            paymentModal.hide();
            alert(data.message);
            location.reload(); // Refresh the page to show updated data
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing the payment');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<script>
// Safely parse embedded JSON from the server; fall back to empty arrays/objects on error
try {
    window.customersWithDebt = JSON.parse('{{ customers_with_debt_json|default:"[]"|escapejs }}');
} catch (e) {
    console.warn('Failed to parse customers_with_debt_json:', e);
    window.customersWithDebt = [];
}
try {
    window.debtPayments = JSON.parse('{{ debt_payments_json|default:"[]"|escapejs }}');
} catch (e) {
    console.warn('Failed to parse debt_payments_json:', e);
    window.debtPayments = [];
}
try {
    window.customerCreditSales = JSON.parse('{{ customer_credit_sales_json|default:"{}"|escapejs }}');
} catch (e) {
    console.warn('Failed to parse customer_credit_sales_json:', e);
    window.customerCreditSales = {};
}

// Debug: Log parsed data to console
console.log('Customer data loaded successfully:', {
    customersWithDebt: window.customersWithDebt,
    debtPayments: window.debtPayments,
    customerCreditSales: window.customerCreditSales
});
</script>
{% endblock %}