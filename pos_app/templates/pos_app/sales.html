{% extends 'pos_app/base.html' %}

{% block title %}Sales List{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Sales List</h1>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <div class="card mb-4">
        <div class="card-body">
            <form method="get">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" id="search" name="search" class="form-control" placeholder="Search..." value="{{ search_query }}">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="status" class="form-label">Status</label>
                        <select id="status" name="status" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="completed" {% if status == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="voided" {% if status == 'voided' %}selected{% endif %}>Voided</option>
                            <option value="refunded" {% if status == 'refunded' %}selected{% endif %}>Refunded</option>
                            <option value="canceled" {% if status == 'canceled' %}selected{% endif %}>Canceled</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="payment_method" class="form-label">Payment Method</label>
                        <select id="payment_method" name="payment_method" class="form-select">
                            <option value="">All Payment Methods</option>
                            <option value="cash" {% if payment_method == 'cash' %}selected{% endif %}>Cash</option>
                            <option value="card" {% if payment_method == 'card' %}selected{% endif %}>Card</option>
                            <option value="mobile_payment" {% if payment_method == 'mobile_payment' %}selected{% endif %}>Mobile Payment</option>
                            <option value="credit" {% if payment_method == 'credit' %}selected{% endif %}>Credit</option>
                            <option value="bank_transfer" {% if payment_method == 'bank_transfer' %}selected{% endif %}>Bank Transfer</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="customer" class="form-label">Customer</label>
                        <select id="customer" name="customer" class="form-select">
                            <option value="">All Customers</option>
                            {% for customer_option in customers %}
                            <option value="{{ customer_option.id }}" {% if customer == customer_option.id|stringformat:"s" %}selected{% endif %}>{{ customer_option.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="employee" class="form-label">Served By</label>
                        <select id="employee" name="employee" class="form-select">
                            <option value="">All Employees</option>
                            {% for employee_option in employees %}
                            <option value="{{ employee_option.id }}" {% if employee == employee_option.id|stringformat:"s" %}selected{% endif %}>{{ employee_option.user.get_full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-9 col-md-6 d-flex align-items-end">
                        <div class="btn-group w-100" role="group">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-1"></i> Filter
                            </button>
                            <a href="{% url 'pos:sales_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-1"></i> Reset
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Invoice #</th>
                            <th>Date/Time</th>
                            <th>Customer</th>
                            <th>Payment Method</th>
                            <th>Subtotal</th>
                            <th>Tax</th>
                            <th>Discount</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Debt</th>
                            <th>Served By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sale in sales %}
                            <tr class="{% if sale.status == 'voided' %}table-secondary{% elif sale.status == 'refunded' %}table-warning{% elif sale.status == 'pending' %}table-info{% endif %}">
                                <td>
                                    <a href="{% url 'pos:sale_detail' sale.id %}" class="text-decoration-none">
                                        <strong>{{ sale.invoice_number }}</strong>
                                    </a>
                                </td>
                                <td>
                                    <small>{{ sale.created_at|date:"M d, Y" }}</small><br>
                                    <small class="text-muted">{{ sale.created_at|date:"H:i" }}</small>
                                </td>
                                <td>
                                    {% if sale.customer %}
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user text-primary me-2"></i>
                                            <div>
                                                <strong>{{ sale.customer.full_name }}</strong>
                                                {% if sale.customer.phone %}
                                                    <br><small class="text-muted">{{ sale.customer.phone }}</small>
                                                {% endif %}
                                                {% if sale.payment_method == 'credit' %}
                                                    <br><small class="badge bg-warning">Credit Sale</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-user-slash me-1"></i>Walk-in Customer
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge {% if sale.payment_method == 'cash' %}bg-success{% elif sale.payment_method == 'card' %}bg-primary{% elif sale.payment_method == 'credit' %}bg-warning{% elif sale.payment_method == 'mobile_payment' %}bg-info{% else %}bg-secondary{% endif %}">
                                        {% if sale.payment_method == 'cash' %}
                                            <i class="fas fa-money-bill-wave me-1"></i>Cash
                                        {% elif sale.payment_method == 'card' %}
                                            <i class="fas fa-credit-card me-1"></i>Card
                                        {% elif sale.payment_method == 'credit' %}
                                            <i class="fas fa-handshake me-1"></i>Credit
                                        {% elif sale.payment_method == 'mobile_payment' %}
                                            <i class="fas fa-mobile-alt me-1"></i>Mobile
                                        {% elif sale.payment_method == 'bank_transfer' %}
                                            <i class="fas fa-university me-1"></i>Transfer
                                        {% else %}
                                            {{ sale.payment_method|title }}
                                        {% endif %}
                                    </span>
                                </td>
                                <td>{{ business.currency_symbol }}{{ sale.subtotal|floatformat:2 }}</td>
                                <td>
                                    {% if sale.tax_amount > 0 %}
                                        <span class="text-success">{{ business.currency_symbol }}{{ sale.tax_amount|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if sale.discount_amount > 0 %}
                                        <span class="text-info">{{ business.currency_symbol }}{{ sale.discount_amount|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td><strong>{{ business.currency_symbol }}{{ sale.total_amount|floatformat:2 }}</strong></td>
                                <td>
                                    {% if sale.status == 'completed' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Completed
                                        </span>
                                    {% elif sale.status == 'pending' %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock me-1"></i>Pending
                                        </span>
                                    {% elif sale.status == 'voided' %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-times me-1"></i>Voided
                                        </span>
                                    {% elif sale.status == 'refunded' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-undo me-1"></i>Refunded
                                        </span>
                                    {% else %}
                                        <span class="badge bg-dark">{{ sale.status|title }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if sale.is_credit_sale %}
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center">
                                                <span class="badge {% if sale.debt_paid %}bg-success{% else %}bg-warning{% endif %}">
                                                    {% if sale.debt_paid %}
                                                        <i class="fas fa-check-circle me-1"></i>Paid
                                                    {% else %}
                                                        <i class="fas fa-exclamation-circle me-1"></i>Outstanding
                                                    {% endif %}
                                                </span>
                                                <small class="text-muted ms-2">Paid: {{ business.currency_symbol }}{{ sale.debt_paid_amount|default:0|floatformat:2 }}</small>
                                            </div>
                                            <div class="mt-1">
                                                <small class="text-muted">Remaining: <span class="sale-remaining" data-total="{{ sale.total_amount }}" data-paid="{{ sale.debt_paid_amount|default:0 }}">{{ business.currency_symbol }}0.00</span></small>
                                            </div>
                                            <div class="mt-2 w-100">
                                                <div class="progress" style="height:8px; background:#e9ecef; border-radius:6px;">
                                                    <div class="progress-bar bg-success" role="progressbar" style="width:0%" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if sale.employee %}
                                        <small>{{ sale.employee.user.get_full_name|default:sale.employee.user.username }}</small>
                                    {% else %}
                                        <small class="text-muted">System</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            Actions
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="{% url 'pos:sale_detail' sale.id %}">
                                                <i class="fas fa-eye me-2"></i>View Details
                                            </a></li>
                                            <li><a class="dropdown-item" href="{% url 'pos:get_receipt' sale.id %}" target="_blank">
                                                <i class="fas fa-print me-2"></i>Print Receipt
                                            </a></li>
                                            {% if sale.status == 'completed' and role in 'owner,admin,manager'|make_list %}
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-warning" href="#" onclick="voidSale({{ sale.id }})">
                                                <i class="fas fa-ban me-2"></i>Void Sale
                                            </a></li>
                                            {% if sale.payment_method == 'credit' %}
                                            <li><a class="dropdown-item text-info" href="#" onclick="convertToCreditNote({{ sale.id }})">
                                                <i class="fas fa-file-invoice me-2"></i>Create Credit Note
                                            </a></li>
                                            {% endif %}
                                            {% endif %}
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="11" class="text-center py-4">
                                    <i class="fas fa-shopping-cart text-muted mb-3" style="font-size: 2rem;"></i>
                                    <br>No sales found with the current filters.
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="card-footer">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Total Sales: {{ business.currency_symbol }}{{ totals.total_sales|default:0|floatformat:2 }}</strong><br>
                        <strong>Total Tax: {{ business.currency_symbol }}{{ totals.total_tax|default:0|floatformat:2 }}</strong><br>
                        <strong>Total Discount: {{ business.currency_symbol }}{{ totals.total_discount|default:0|floatformat:2 }}</strong>
                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-sm-6">
                                <strong>By Payment Method</strong>
                                <ul class="list-unstyled small mb-0">
                                    {% for method, info in payment_breakdown.items %}
                                        <li>{{ method|title }}: {{ business.currency_symbol }}{{ info.total|floatformat:2 }} ({{ info.count }})</li>
                                    {% empty %}
                                        <li class="text-muted">No payments</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="col-sm-6">
                                <strong>By Status</strong>
                                <ul class="list-unstyled small mb-0">
                                    {% for status_key, info in status_breakdown.items %}
                                        <li>{{ status_key|title }}: {{ business.currency_symbol }}{{ info.total|floatformat:2 }} ({{ info.count }})</li>
                                    {% empty %}
                                        <li class="text-muted">No statuses</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-2 d-flex justify-content-end">
                    <a href="#" class="btn btn-outline-primary btn-sm">Export</a>
                </div>
            </div>
                        {% if sales.has_previous %}
                            <a href="?page=1&start_date={{ start_date }}&end_date={{ end_date }}&status={{ status }}&payment_method={{ payment_method }}&search={{ search_query }}" class="btn btn-outline-secondary btn-sm">First</a>
                            <a href="?page={{ sales.previous_page_number }}&start_date={{ start_date }}&end_date={{ end_date }}&status={{ status }}&payment_method={{ payment_method }}&search={{ search_query }}" class="btn btn-outline-secondary btn-sm">Previous</a>
                        {% endif %}
                        <span class="px-2">Page {{ sales.number }} of {{ sales.paginator.num_pages }}</span>
                        {% if sales.has_next %}
                            <a href="?page={{ sales.next_page_number }}&start_date={{ start_date }}&end_date={{ end_date }}&status={{ status }}&payment_method={{ payment_method }}&search={{ search_query }}" class="btn btn-outline-secondary btn-sm">Next</a>
                            <a href="?page={{ sales.paginator.num_pages }}&start_date={{ start_date }}&end_date={{ end_date }}&status={{ status }}&payment_method={{ payment_method }}&search={{ search_query }}" class="btn btn-outline-secondary btn-sm">Last</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function voidSale(saleId) {
    if (confirm('Are you sure you want to void this sale? This action cannot be undone.')) {
        fetch(`/pos/sales/${saleId}/void/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while voiding the sale.');
        });
    }
}

function convertToCreditNote(saleId) {
    if (confirm('Create a credit note for this sale? This will generate a credit note document.')) {
        fetch(`/pos/sales/${saleId}/create-credit-note/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.open(data.credit_note_url, '_blank');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while creating the credit note.');
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Calculate and display remaining amounts for credit sales
document.addEventListener('DOMContentLoaded', function() {
    console.log('Sales page loaded, calculating remaining amounts...');
    document.querySelectorAll('.sale-remaining').forEach(function(el) {
        try {
            const total = parseFloat(el.getAttribute('data-total')) || 0;
            const paid = parseFloat(el.getAttribute('data-paid')) || 0;
            const remaining = Math.max(0, total - paid);
            console.log(`Sale: total=${total}, paid=${paid}, remaining=${remaining}`);
            // Update text
            el.textContent = '{{ business.currency_symbol }}' + remaining.toFixed(2);
            // Update progress bar (find nearest progress-bar sibling)
            const row = el.closest('tr');
            if (row) {
                const progress = row.querySelector('.progress-bar');
                if (progress) {
                    const percent = total > 0 ? Math.min(100, ((paid / total) * 100)) : 0;
                    progress.style.width = percent + '%';
                    progress.setAttribute('aria-valuenow', percent.toFixed(0));
                }
                // Update badge text and classes
                const badge = row.querySelector('td .badge');
                if (badge) {
                    if (remaining <= 0) {
                        badge.classList.remove('bg-warning');
                        badge.classList.add('bg-success');
                        badge.innerHTML = '<i class="fas fa-check-circle me-1"></i>Paid';
                    } else {
                        badge.classList.remove('bg-success');
                        badge.classList.add('bg-warning');
                        badge.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>Outstanding';
                    }
                }
            }
        } catch (e) {
            console.warn('Error updating sale remaining:', e);
        }
    });
});
</script>
{% endblock %}