{% extends 'pos_app/base.html' %}

{% block title %}VAT Management{% endblock %}

{% block extra_css %}
<style>
    .vat-container {
        background: #f8fafc;
        min-height: calc(100vh - 120px);
        padding: 2rem 0;
    }

    .vat-header {
        background: linear-gradient(135deg, #7c3aed, #3b82f6);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .vat-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        border-left: 4px solid;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .vat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
    }

    .vat-card.standard { border-left-color: #3b82f6; }
    .vat-card.zero { border-left-color: #10b981; }
    .vat-card.exempt { border-left-color: #f59e0b; }

    .vat-rate-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 700;
        font-size: 1rem;
    }

    .vat-rate-badge.standard { background: #dbeafe; color: #1d4ed8; }
    .vat-rate-badge.zero { background: #d1fae5; color: #065f46; }
    .vat-rate-badge.exempt { background: #fef3c7; color: #92400e; }

    .metric-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        margin-bottom: 1rem;
    }

    .metric-icon.standard { background: #3b82f6; }
    .metric-icon.zero { background: #10b981; }
    .metric-icon.exempt { background: #f59e0b; }

    .btn-modern {
        border-radius: 8px;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border: none;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary-modern {
        background: linear-gradient(135deg, #3b82f6, #6366f1);
        color: white;
    }

    .btn-primary-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -3px rgba(59, 130, 246, 0.3);
        color: white;
    }

    .btn-success-modern {
        background: linear-gradient(135deg, #10b981, #34d399);
        color: white;
    }

    .btn-success-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -3px rgba(16, 185, 129, 0.3);
        color: white;
    }

    .data-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .data-table .table {
        margin-bottom: 0;
    }

    .data-table .table thead th {
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        font-weight: 600;
        color: #475569;
        padding: 1rem;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }

    .data-table .table tbody td {
        padding: 1rem;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    .data-table .table tbody tr:hover {
        background: #f8fafc;
    }

    .vat-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 768px) {
        .vat-summary-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .vat-card {
            padding: 1rem;
        }
        
        .metric-icon {
            width: 50px;
            height: 50px;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        
        .vat-header h1 {
            font-size: 1.5rem;
        }
        
        .vat-header .d-flex {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 1rem;
        }
        
        .btn-modern {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
    }

    @media (max-width: 576px) {
        .vat-container {
            padding: 1rem 0.5rem;
        }
        
        .metric-icon {
            width: 40px;
            height: 40px;
            font-size: 1rem;
        }
        
        .vat-card h4 {
            font-size: 1rem;
        }
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.active { background: #dcfce7; color: #166534; }
    .status-badge.inactive { background: #fecaca; color: #b91c1c; }
</style>
{% endblock %}

{% block content %}
<div class="vat-container">
    <div class="container-fluid">
        <!-- Header -->
        <div class="vat-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="bi bi-percent me-3"></i>VAT Management</h1>
                    <p class="mb-0">Manage VAT categories and tax compliance for {{ business.name }}</p>
                </div>
                <div class="d-flex gap-2">
                    {% if role in 'owner,admin' %}
                    <button class="btn-primary-modern btn-modern" data-bs-toggle="modal" data-bs-target="#addVATModal">
                        <i class="bi bi-plus-circle"></i> Add VAT Category
                    </button>
                    <a href="#vat-report" class="btn-success-modern btn-modern">
                        <i class="bi bi-file-earmark-text"></i> VAT Report
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- VAT Summary Cards -->
        <div class="vat-summary-grid">
            <div class="vat-card standard">
                <div class="d-flex align-items-center">
                    <div class="metric-icon standard">
                        <i class="bi bi-receipt"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h4 class="mb-1">Standard Rated (A)</h4>
                        <p class="text-muted mb-2">Standard VAT rate for most goods and services</p>
                        <span class="vat-rate-badge standard">16% VAT</span>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="d-flex justify-content-between">
                        <span>Products in category:</span>
                        <strong>{{ standard_products_count|default:0 }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>VAT collected (this month):</span>
                        <strong>{{ business.currency_symbol }} {{ standard_vat_collected|floatformat:2|default:"0.00" }}</strong>
                    </div>
                </div>
            </div>

            <div class="vat-card zero">
                <div class="d-flex align-items-center">
                    <div class="metric-icon zero">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h4 class="mb-1">Zero Rated (B)</h4>
                        <p class="text-muted mb-2">Essential goods with 0% VAT rate</p>
                        <span class="vat-rate-badge zero">0% VAT</span>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="d-flex justify-content-between">
                        <span>Products in category:</span>
                        <strong>{{ zero_products_count|default:0 }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Sales value (this month):</span>
                        <strong>{{ business.currency_symbol }} {{ zero_sales_value|floatformat:2|default:"0.00" }}</strong>
                    </div>
                </div>
            </div>

            <div class="vat-card exempt">
                <div class="d-flex align-items-center">
                    <div class="metric-icon exempt">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h4 class="mb-1">Exempt (E)</h4>
                        <p class="text-muted mb-2">VAT exempt goods and services</p>
                        <span class="vat-rate-badge exempt">Exempt</span>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="d-flex justify-content-between">
                        <span>Products in category:</span>
                        <strong>{{ exempt_products_count|default:0 }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Sales value (this month):</span>
                        <strong>{{ business.currency_symbol }} {{ exempt_sales_value|floatformat:2|default:"0.00" }}</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- VAT Categories Table -->
        <div class="data-table">
            <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>VAT Categories</h5>
                <span class="badge bg-primary">{{ vat_categories.count }} Categories</span>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Rate (%)</th>
                        <th>Products</th>
                        <th>Status</th>
                        {% if role in 'owner,admin' %}
                        <th>Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for vat_category in vat_categories %}
                    <tr>
                        <td>
                            <span class="badge bg-{% if vat_category.code == 'A' %}primary{% elif vat_category.code == 'B' %}success{% else %}warning{% endif %} fs-6">
                                {{ vat_category.code }}
                            </span>
                        </td>
                        <td><strong>{{ vat_category.name }}</strong></td>
                        <td>{{ vat_category.description|truncatewords:10 }}</td>
                        <td>
                            {% if vat_category.rate > 0 %}
                                <strong class="text-primary">{{ vat_category.rate }}%</strong>
                            {% else %}
                                <span class="text-success"><strong>{{ vat_category.rate }}%</strong></span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info">{{ vat_category.product_count|default:0 }} items</span>
                        </td>
                        <td>
                            {% if vat_category.is_active %}
                                <span class="status-badge active">Active</span>
                            {% else %}
                                <span class="status-badge inactive">Inactive</span>
                            {% endif %}
                        </td>
                        {% if role in 'owner,admin' %}
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-sm" onclick="editVATCategory({{ vat_category.id }})" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteVATCategory({{ vat_category.id }})" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{% if role in 'owner,admin' %}7{% else %}6{% endif %}" class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">No VAT categories found. Add some to get started.</p>
                            {% if role in 'owner,admin' %}
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVATModal">
                                <i class="bi bi-plus-circle me-2"></i>Add First VAT Category
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- VAT Compliance Info -->
        <div class="vat-card">
            <div class="row">
                <div class="col-lg-8">
                    <h4><i class="bi bi-info-circle text-info me-2"></i>VAT Compliance Information</h4>
                    <p class="text-muted">Ensure your business stays compliant with Kenyan VAT regulations:</p>
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Standard rate: 16% on most goods and services</li>
                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Zero rate: 0% on essential items like basic foodstuffs</li>
                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Exempt: No VAT charged on financial services, medical services</li>
                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>File VAT returns monthly by 20th of following month</li>
                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i>Keep proper records of all VAT transactions</li>
                    </ul>
                </div>
                <div class="col-lg-4 text-center">
                    <div class="p-4 bg-light rounded">
                        <i class="bi bi-shield-check text-success" style="font-size: 4rem;"></i>
                        <h5 class="mt-3">KRA Compliant</h5>
                        <p class="text-muted">Your VAT setup follows Kenya Revenue Authority guidelines</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add VAT Category Modal -->
{% if role in 'owner,admin' %}
<div class="modal fade" id="addVATModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add VAT Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'pos:add_vat_category' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="vat_name" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="vat_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="vat_code" class="form-label">VAT Code</label>
                        <select class="form-select" id="vat_code" name="code" required>
                            <option value="">Select Code</option>
                            <option value="A">A - Standard Rated (16%)</option>
                            <option value="B">B - Zero Rated (0%)</option>
                            <option value="E">E - Exempt</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="vat_rate" class="form-label">VAT Rate (%)</label>
                        <input type="number" class="form-control" id="vat_rate" name="rate" step="0.01" min="0" max="100" required>
                    </div>
                    <div class="mb-3">
                        <label for="vat_description" class="form-label">Description</label>
                        <textarea class="form-control" id="vat_description" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="vat_active" name="is_active" checked>
                        <label class="form-check-label" for="vat_active">
                            Active
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Edit VAT Category Modal -->
{% if role in 'owner,admin' %}
<div class="modal fade" id="editVATModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Edit VAT Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_vat_name" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="edit_vat_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_vat_code" class="form-label">VAT Code</label>
                        <select class="form-select" id="edit_vat_code" name="code" required>
                            <option value="">Select Code</option>
                            <option value="A">A - Standard Rate (16%)</option>
                            <option value="B">B - Zero Rate (0%)</option>
                            <option value="C">C - Reduced Rate</option>
                            <option value="E">E - Exempt (0%)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_vat_rate" class="form-label">VAT Rate (%)</label>
                        <input type="number" class="form-control" id="edit_vat_rate" name="rate" step="0.01" min="0" max="100" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_vat_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_vat_description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active" checked>
                            <label class="form-check-label" for="edit_is_active">
                                Active
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update VAT Category</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-fill rate based on code selection
    document.getElementById('vat_code').addEventListener('change', function() {
        const rateInput = document.getElementById('vat_rate');
        switch(this.value) {
            case 'A':
                rateInput.value = '16.00';
                break;
            case 'B':
                rateInput.value = '0.00';
                break;
            case 'E':
                rateInput.value = '0.00';
                break;
            default:
                rateInput.value = '';
        }
    });
});

function editVATCategory(id) {
    // Get VAT category data from the table row
    const row = document.querySelector(`button[onclick="editVATCategory(${id})"]`).closest('tr');
    const cells = row.querySelectorAll('td');
    const name = cells[0].textContent.trim();
    const code = cells[1].textContent.trim();
    const rate = cells[2].textContent.replace('%', '').trim();
    const description = cells[3].textContent.trim();
    const isActive = cells[4].querySelector('.badge-success') !== null;
    
    // Populate the edit modal form
    document.getElementById('edit_vat_name').value = name;
    document.getElementById('edit_vat_code').value = code;
    document.getElementById('edit_vat_rate').value = rate;
    document.getElementById('edit_vat_description').value = description;
    document.getElementById('edit_is_active').checked = isActive;
    
    // Update form action
    const editForm = document.querySelector('#editVATModal form');
    editForm.action = `/pos/vat-management/edit-category/${id}/`;
    
    // Show the edit modal
    const editModal = new bootstrap.Modal(document.getElementById('editVATModal'));
    editModal.show();
}

function deleteVATCategory(id) {
    if (confirm('Are you sure you want to delete this VAT category? This action cannot be undone.')) {
        // Create a form to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/pos/vat-management/delete-category/${id}/`;
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        // Submit the form
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}