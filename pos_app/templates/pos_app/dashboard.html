{% extends 'pos_app/base.html' %}

{% block title %}Business Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.css">
<style>
    :root {
        --primary-color: #4f46e5;
        --secondary-color: #06b6d4;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --info-color: #3b82f6;
        --light-bg: #f8fafc;
        --card-shadow: 0 4px 6px -1px rgba(0,                     <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Invoice</th>
                                    <th>Customer</th>
                                    <th>Total</th>
                                    <th>Date</th>
                                </tr>
                            </thead>);
        --border-radius: 12px;
        --gradient-primary: linear-gradient(135deg, #4f46e5, #3b82f6);
        --gradient-success: linear-gradient(135deg, #10b981, #34d399);
        --gradient-warning: linear-gradient(135deg, #f59e0b, #fbbf24);
        --gradient-danger: linear-gradient(135deg, #ef4444, #f87171);
        --gradient-info: linear-gradient(135deg, #3b82f6, #60a5fa);
        --gradient-secondary: linear-gradient(135deg, #06b6d4, #22d3ee);
    }

    body {
        background: var(--light-bg);
    }

    .dashboard-container {
        padding: 2rem 0;
        min-height: calc(100vh - 120px);
    }

    .dashboard-header {
        background: var(--gradient-primary);
        color: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
    }

    .dashboard-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .dashboard-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 0;
    }

    .metric-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--card-shadow);
        border-left: 4px solid;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(30px, -30px);
    }

    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
    }

    .metric-card.revenue { 
        border-left-color: var(--success-color);
        background: linear-gradient(135deg, #ffffff, #f0fdf4);
    }
    .metric-card.sales { 
        border-left-color: var(--primary-color);
        background: linear-gradient(135deg, #ffffff, #eff6ff);
    }
    .metric-card.profit { 
        border-left-color: var(--info-color);
        background: linear-gradient(135deg, #ffffff, #f0f9ff);
    }
    .metric-card.customers { 
        border-left-color: var(--secondary-color);
        background: linear-gradient(135deg, #ffffff, #ecfeff);
    }
    .metric-card.inventory { 
        border-left-color: var(--warning-color);
        background: linear-gradient(135deg, #ffffff, #fffbeb);
    }
    .metric-card.debt { 
        border-left-color: var(--danger-color);
        background: linear-gradient(135deg, #ffffff, #fef2f2);
    }

    .metric-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        margin-bottom: 1rem;
    }

    .metric-icon.revenue { background: var(--success-color); }
    .metric-icon.sales { background: var(--primary-color); }
    .metric-icon.profit { background: var(--info-color); }
    .metric-icon.customers { background: var(--secondary-color); }
    .metric-icon.inventory { background: var(--warning-color); }
    .metric-icon.debt { background: var(--danger-color); }

    .metric-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }

    .metric-label {
        font-size: 0.9rem;
        color: #64748b;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
    }

    .metric-change {
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .metric-change.positive {
        color: var(--success-color);
    }

    .metric-change.negative {
        color: var(--danger-color);
    }

    .metric-change.neutral {
        color: #64748b;
    }

    .chart-container {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
    }

    .chart-wrapper {
        height: 300px;
        position: relative;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #f1f5f9;
        padding-bottom: 1rem;
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0;
    }

    .chart-subtitle {
        font-size: 0.9rem;
        color: #64748b;
        margin-bottom: 0;
    }

    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .action-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        text-decoration: none;
        color: inherit;
        transition: all 0.3s ease;
        border-left: 4px solid;
    }

    .action-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px -3px rgba(0, 0, 0, 0.1);
        color: inherit;
        text-decoration: none;
    }

    .action-card.new-sale { border-left-color: var(--primary-color); }
    .action-card.add-product { border-left-color: var(--success-color); }
    .action-card.customer { border-left-color: var(--secondary-color); }
    .action-card.reports { border-left-color: var(--warning-color); }

    .action-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
        margin-bottom: 0.5rem;
    }

    .action-icon.new-sale { background: var(--primary-color); }
    .action-icon.add-product { background: var(--success-color); }
    .action-icon.customer { background: var(--secondary-color); }
    .action-icon.reports { background: var(--warning-color); }

    .action-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: #1e293b;
    }

    .data-table {
        background: white;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
    }

    .data-table .table {
        margin-bottom: 0;
    }

    .data-table .table thead th {
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        font-weight: 600;
        color: #475569;
        padding: 1rem;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }

    .data-table .table tbody td {
        padding: 1rem;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }

    .data-table .table tbody tr:hover {
        background: #f8fafc;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.completed { background: #dcfce7; color: #166534; }
    .status-badge.pending { background: #fef3c7; color: #92400e; }
    .status-badge.cancelled { background: #fecaca; color: #b91c1c; }
    .status-badge.low-stock { background: #fed7d7; color: #c53030; }
    .status-badge.in-stock { background: #c6f6d5; color: #2f855a; }

    .alert-modern {
        border: none;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        border-left: 4px solid;
    }

    .alert-modern.alert-info { 
        background: #f0f9ff;
        border-left-color: var(--info-color);
        color: #1e40af;
    }

    .alert-modern.alert-warning { 
        background: #fffbeb;
        border-left-color: var(--warning-color);
        color: #92400e;
    }

    @media (max-width: 768px) {
        .dashboard-header h1 {
            font-size: 2rem;
        }
        
        .metric-card {
            margin-bottom: 1rem;
        }
        
        .chart-container {
            padding: 1rem;
        }
        
        .quick-actions {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container-fluid">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="bi bi-speedometer2 me-3"></i>Business Dashboard</h1>
                    <p class="dashboard-subtitle">Welcome back, {{ user.get_full_name }}! Here's your business overview.</p>
                </div>
                <div class="d-flex gap-2">
                    {% if role in 'owner,admin,manager,cashier' %}
                    <a href="{% url 'pos:pos' %}" class="btn btn-light btn-lg">
                        <i class="bi bi-cart-plus me-2"></i>New Sale
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Key Metrics Grid -->
        <div class="row mb-4">
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-3">
                <div class="metric-card revenue">
                    <div class="metric-icon revenue">
                        <i class="bi bi-currency-dollar"></i>
                    </div>
                    <div class="metric-value">{{ business.currency_symbol }}{{ total_revenue|floatformat:0 }}</div>
                    <div class="metric-label">Total Revenue</div>
                    <div class="metric-change positive">
                        <i class="bi bi-arrow-up"></i> +12% from last month
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-3">
                <div class="metric-card sales">
                    <div class="metric-icon sales">
                        <i class="bi bi-receipt"></i>
                    </div>
                    <div class="metric-value">{{ total_sales_count|default:0 }}</div>
                    <div class="metric-label">Total Sales</div>
                    <div class="metric-change positive">
                        <i class="bi bi-arrow-up"></i> +8% from last month
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-3">
                <div class="metric-card profit">
                    <div class="metric-icon profit">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="metric-value">{{ business.currency_symbol }}{{ net_profit|floatformat:0 }}</div>
                    <div class="metric-label">Net Profit</div>
                    <div class="metric-change {% if net_profit >= 0 %}positive{% else %}negative{% endif %}">
                        <i class="bi bi-arrow-{% if net_profit >= 0 %}up{% else %}down{% endif %}"></i>
                        {% if net_profit >= 0 %}+5%{% else %}-3%{% endif %} from last month
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-3">
                <div class="metric-card customers">
                    <div class="metric-icon customers">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="metric-value">{{ total_customers|default:0 }}</div>
                    <div class="metric-label">Customers</div>
                    <div class="metric-change positive">
                        <i class="bi bi-arrow-up"></i> +15% new customers
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-3">
                <div class="metric-card inventory">
                    <div class="metric-icon inventory">
                        <i class="bi bi-boxes"></i>
                    </div>
                    <div class="metric-value">{{ total_products|default:0 }}</div>
                    <div class="metric-label">Products</div>
                    <div class="metric-change neutral">
                        <i class="bi bi-exclamation-triangle"></i> {{ low_stock_count }} low stock
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-3">
                <div class="metric-card debt">
                    <div class="metric-icon debt">
                        <i class="bi bi-credit-card"></i>
                    </div>
                    <div class="metric-value">{{ business.currency_symbol }}{{ total_debt|floatformat:0 }}</div>
                    <div class="metric-label">Outstanding Debt</div>
                    <div class="metric-change {% if total_debt > 0 %}negative{% else %}positive{% endif %}">
                        <i class="bi bi-{% if total_debt > 0 %}exclamation-triangle{% else %}check-circle{% endif %}"></i>
                        {{ customers_with_debt|default:0 }} customers
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            {% if role in 'owner,admin,manager,cashier' %}
            <a href="{% url 'pos:pos' %}" class="action-card new-sale">
                <div class="action-icon new-sale">
                    <i class="bi bi-cart-plus"></i>
                </div>
                <div class="action-title">New Sale</div>
            </a>
            {% endif %}
            
            {% if role in 'owner,admin,manager,inventory' %}
            <a href="{% url 'pos:product_create' %}" class="action-card add-product">
                <div class="action-icon add-product">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="action-title">Add Product</div>
            </a>
            {% endif %}
            
            {% if role in 'owner,admin,manager,cashier' %}
            <a href="{% url 'pos:customer_create' %}" class="action-card customer">
                <div class="action-icon customer">
                    <i class="bi bi-person-plus"></i>
                </div>
                <div class="action-title">Add Customer</div>
            </a>
            {% endif %}
            
            {% if role in 'owner,admin,manager' %}
            <a href="{% url 'pos:reports' %}" class="action-card reports">
                <div class="action-icon reports">
                    <i class="bi bi-bar-chart"></i>
                </div>
                <div class="action-title">View Reports</div>
            </a>
            {% endif %}
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-8 col-md-12 col-sm-12">
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <h4 class="chart-title">Sales Trend</h4>
                            <p class="chart-subtitle">Revenue over the last 30 days</p>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="salesTrendChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-12 col-sm-12">
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <h4 class="chart-title">Sales Breakdown</h4>
                            <p class="chart-subtitle">Payment methods distribution</p>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="paymentBreakdownChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables Row -->
        <div class="row">
            <div class="col-lg-6 col-md-12 col-sm-12 mb-4">
                <div class="data-table">
                    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                        <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Recent Sales</h5>
                        <a href="{% url 'pos:sales_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Invoice</th>
                                <th>Customer</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in recent_sales %}
                            <tr>
                                <td><strong>{{ sale.invoice_number }}</strong></td>
                                <td>{{ sale.customer.full_name|default:"Walk-in" }}</td>
                                <td><strong>{{ business.currency_symbol }} {{ sale.total_amount|floatformat:2 }}</strong></td>
                                <td>
                                    <span class="status-badge completed">{{ sale.get_status_display }}</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2">No recent sales</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="col-lg-6 col-md-12 col-sm-12 mb-4">
                <div class="data-table">
                    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle text-warning me-2"></i>Low Stock Alert</h5>
                        <a href="{% url 'pos:product_list' %}" class="btn btn-sm btn-outline-warning">Manage Stock</a>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Stock</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in low_stock_products %}
                            <tr>
                                <td><strong>{{ product.name }}</strong></td>
                                <td><strong>{{ product.stock_quantity }} {{ product.unit|default:"pcs" }}</strong></td>
                                <td>
                                    {% if product.stock_quantity == 0 %}
                                        <span class="status-badge cancelled">Out of Stock</span>
                                    {% else %}
                                        <span class="status-badge low-stock">Low Stock</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center py-4">
                                    <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                                    <p class="text-success mt-2">All products well stocked!</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Alerts and Notifications -->
        {% if customers_with_debt > 0 %}
        <div class="alert alert-modern alert-warning mb-3">
            <div class="d-flex align-items-center">
                <i class="bi bi-credit-card fs-4 me-3"></i>
                <div>
                    <h6 class="mb-1">Outstanding Customer Debt</h6>
                    <p class="mb-0">{{ customers_with_debt }} customers have outstanding debt totaling {{ business.currency_symbol }} {{ total_debt|floatformat:2 }}. 
                    <a href="#" class="fw-bold">Manage Debt</a></p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if low_stock_count > 0 %}
        <div class="alert alert-modern alert-info mb-3">
            <div class="d-flex align-items-center">
                <i class="bi bi-boxes fs-4 me-3"></i>
                <div>
                    <h6 class="mb-1">Inventory Alert</h6>
                    <p class="mb-0">{{ low_stock_count }} products are running low on stock. 
                    <a href="{% url 'pos:product_list' %}" class="fw-bold">Manage Inventory</a></p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sales Trend Chart
    const salesTrendCtx = document.getElementById('salesTrendChart');
    if (salesTrendCtx) {
        const salesData = {{ sales_trend_data|default:"[]"|safe }};
        new Chart(salesTrendCtx, {
            type: 'line',
            data: {
                labels: salesData.map(d => d.date),
                datasets: [{
                    label: 'Daily Revenue',
                    data: salesData.map(d => d.revenue),
                    borderColor: '#4f46e5',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                    x: { grid: { color: '#f1f5f9' } }
                }
            }
        });
    }

    // Payment Breakdown Chart
    const paymentCtx = document.getElementById('paymentBreakdownChart');
    if (paymentCtx) {
        const paymentData = {{ payment_method_data|default:"[]"|safe }};
        new Chart(paymentCtx, {
            type: 'doughnut',
            data: {
                labels: paymentData.map(d => d.method),
                datasets: [{
                    data: paymentData.map(d => d.count),
                    backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#06b6d4'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
});
</script>
{% endblock %}